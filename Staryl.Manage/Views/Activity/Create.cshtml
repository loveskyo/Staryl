@{
    ViewBag.Title = "Create";
    string StaticDomain = Staryl.Manage.Controllers.ControllerBase.StaticDomain;
}
@section style {
    <!-- daterange picker -->
    <link rel="stylesheet" href="@(StaticDomain)plugins/datepicker/datepicker3.css">
    <style>
        #upimg {
            width: 100%;
        }

            #upimg .webuploader-pick {
                width: 100%;
            }
        .imgadd {
            width: 91px;
            height: 91px;
            float: left;
            border: 1px solid #d3d3d3;
            margin-right: 16px;
            background: url(@(StaticDomain)/img/cp_img_tj.png) no-repeat;
        }
    </style>
}
<!-- Content Header (Page header) -->
<section class="content-header">
    <h1>
        新增活动
        <small>新增一个活动</small>
    </h1>
    <ol class="breadcrumb">
        <li><a href="/"><i class="fa fa-dashboard"></i> 首页</a></li>
        <li><a href="/activity">活动管理</a></li>
        <li class="active">新增活动</li>
    </ol>
</section>
<!-- Main content -->
<section class="content">
    <div class="box box-info">
        <div class="box-header with-border">
            <h3 class="box-title"></h3>
        </div>
        <!-- /.box-header -->
        <!-- form start -->
        <form id="addform" method="post" action="/activity/create" class="form-horizontal">
            <div class="box-body">
                <div class="col-md-10">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">活动类型</label>
                        <div class="col-sm-6">
                            <select name="ParentId" class="form-control select2" style="width: 150px;">
                                <option value="0">请选择</option>
                                
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">收费级别</label>
                        <div class="col-sm-6">
                            <select name="ParentId" class="form-control select2" style="width: 150px;">
                                <option value="0">所有免费</option>
                                <option value="1">会员免费</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label">活动主题</label>
                        <div class="col-sm-6">
                            <input type="text" class="form-control" id="activityName" name="activityName" value="" placeholder="输入栏目名称" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">活动简介</label>
                        <div class="col-sm-6">
                            <textarea id="BriefIntroduction" name="BriefIntroduction" rows="5" cols="80" style="width:100%"></textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">活动内容</label>
                        <div class="col-sm-10">
                            <textarea id="Content" name="Content" rows="10" cols="80">
                                This is my textarea to be replaced with CKEditor.
                            </textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="inputSkills" class="col-sm-2 control-label">活动所在地</label>
                        <div class="col-sm-10">
                            <select class="select2" name="Province" id="Province" style="width:150px;">
                                <option value="-1">省</option>
                            </select>
                            <select class="select2" name="City" id="City" style="width:150px;">
                                <option value="-1">市</option>
                            </select>
                            <select class="select2" name="Area" id="Area" style="width:150px;">
                                <option value="-1">区/县</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">活动状态</label>
                        <div class="col-sm-6">
                            <select name="Status" class="form-control select2" style="width:150px;">
                                <option value="0">报名中</option>
                                <option value="1">进行中</option>
                                <option value="1">已结束</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label">活动图片</label>
                        <div class="col-sm-10">
                                <div id="fileLists">
                                </div>
                                <div class="imgadd" id="filePickers"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label">是否发布</label>
                        <div class="col-sm-10">
                            <div class="checkbox">
                                <input type="checkbox" id="IsRecommend" name="IsRecommend" checked="checked" value="true" data-on-text="是" data-off-text="否" /> （选“是”前端才会显示）
                            </div>
                        </div>
                    </div>


                    <div class="form-group">
                        <label class="col-sm-2 control-label">
                            &nbsp;
                        </label>
                        <div class="col-sm-10">
                            <button type="submit" class="btn btn-success btn-sm">
                                提 交
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /.box-body -->

        </form>


    </div>
</section>
<!-- /.content -->
@section scripts {
    <script src="@(StaticDomain)js/bootstrapValidator.min.js"></script>
    <script src="@(StaticDomain)js/language/zh_CN.js"></script>
    <script src="@(StaticDomain)plugins/datepicker/bootstrap-datepicker.js"></script>
    <script src="@(StaticDomain)plugins/datepicker/locales/bootstrap-datepicker.zh-CN.js"></script>
<script src="//cdn.ckeditor.com/4.5.8/standard/ckeditor.js"></script>

        <script type="text/javascript">
        var BASE_URL = "@(StaticDomain)";
        var city = "-1";
        var area = "-1";
        $(function () {
            //parent.$.Setactivity("user/create");
            $(".select2").select2();
            $("#IsRecommend").bootstrapSwitch();

            $(".date").datepicker({ clearBtn: true, format: "yyyy-mm-dd", language: "zh-CN" });

            CKEDITOR.replace('Content', {
                //图片上传发送路径，returnURL为参数,到服务器后跳转回来的页面  
                filebrowserImageUploadUrl: '/activity/UploadImg'
            });

            Province = function () {
                var param = { "parentId": 0 };
                jsonAjax({
                    url: "/area/GetAreaByParentId", param: param, callback: function (result) {
                        bindSelect(result, $("#Province"));
                    }
                });
            }

            $("#Province").change(function () {
                if ($(this).val() == "-1") {
                    bindSelect(null, $("#City"));
                    bindSelect(null, $("#Area"));
                    return;
                }
                var param = { "parentId": $(this).val() };
                jsonAjax({
                    url: "/area/GetAreaByParentId", param: param, callback: function (result) {
                        bindSelect(result, $("#City"));
                    }
                });
            });

            $("#City").change(function () {
                if ($(this).val() == "-1") {
                    bindSelect(null, $("#Area"));
                    return;
                }
                var param = { "parentId": $(this).val() };
                jsonAjax({
                    url: "/area/GetAreaByParentId", param: param, callback: function (result) {
                        bindSelect(result, $("#Area"));
                    }
                });
            });

            bindSelect = function (result, obj) {
                var selectval = "-1";
                var text = "省";
                if (obj.attr("id") == "City") {
                    selectval = city;
                    city = "-1";
                    text = "市";
                } else if (obj.attr("id") == "Area") {
                    selectval = area;
                    area = "-1";
                    text = "区/县";

                }

                var s = obj.get(0);
                s.options.length = 0;
                s.options.add(new Option(text, "-1"));
                if (result != null) {
                    $.each(result, function (idx, item) {
                        s.options.add(new Option(item.text, item.id));
                    });
                }

                obj.val(selectval).trigger("change");
                if (obj.attr("id") == "City")
                    $("#City").change();
            }
            Province();

            $("#userform").bootstrapValidator({
                message: 'This value is not valid',
                feedbackIcons: {
                    valid: 'glyphicon glyphicon-ok',
                    invalid: 'glyphicon glyphicon-remove',
                    validating: 'glyphicon glyphicon-refresh'
                },
                fields: {
                    Email: {
                        validators: {
                            emailAddress: {
                                message: '请输入正确的邮箱地址'
                            },
                            remote: {
                                url: '/user/CheckMobileOrEmail',
                                type: 'POST',
                                message: '该邮箱已被注册，请使用其他邮箱地址'
                            },
                        }
                    },
                    Mobile: {
                        validators: {
                            notEmpty: {
                                message: '手机号不可为空'
                            },
                            regexp: {
                                regexp: /^(13[0-9]|14[0-9]|15[0-9]|18[0-9])\d{8}$/,
                                message: '请输入正确的手机号码'
                            },
                            remote: {
                                url: '/user/CheckMobileOrEmail',
                                type: 'POST',
                                message: '该手机已被注册，请使用其他手机号码'
                            }
                        }
                    },
                    Password: {
                        validators: {
                            notEmpty: {
                                message: '请输入用户密码'
                            }, stringLength: {
                                min: 6,
                                max: 20,
                                message: '密码为6到20个字符'
                            }
                        }
                    }

                }
            })
           .on('success.form.bv', function (e) {
               e.preventDefault();

               // Get the form instance
               var $form = $(e.target);

               // Get the BootstrapValidator instance
               var bv = $form.data('bootstrapValidator');

               // Use Ajax to submit form data
               $.post($form.attr('action'), $form.serialize(), function (result) {
                   parent.$.CheckLogin(result);
                   if (result.MsgNo == 1) {
                       $("#ParentId").val(result.Msg);
                       $("a[href='#txinfo']").click();
                       //$("#txsubmit").click();
                       //$("a[href='#txinfo']").click();

                   } else {
                       Modal.alert({
                           msg: result.Msg
                       })
                   }
               }, 'json');
           });

            $("#txform").bootstrapValidator({
                message: 'This value is not valid',
                feedbackIcons: {
                    valid: 'glyphicon glyphicon-ok',
                    invalid: 'glyphicon glyphicon-remove',
                    validating: 'glyphicon glyphicon-refresh'
                },
                fields: {
                    RealName: {
                        validators: {
                            notEmpty: {
                                message: '请输入小童星真实姓名'
                            }
                        }
                    },
                    Gender: {
                        validators: {
                            notEmpty: {
                                message: '请选择小童星性别'
                            }
                        }
                    },
                    Birthday: {
                        validators: {
                            notEmpty: {
                                message: '请输入小童星的生日'
                            },
                            date: {
                                format: 'YYYY-MM-DD'
                            }
                        }
                    }

                }
            }).on('success.form.bv', function (e) {
                e.preventDefault();

                // Get the form instance
                var $form = $(e.target);

                // Get the BootstrapValidator instance
                var bv = $form.data('bootstrapValidator');

                // Use Ajax to submit form data
                $.post($form.attr('action'), $form.serialize(), function (result) {
                    parent.$.CheckLogin(result);
                    if (result.MsgNo == 1) {
                        location = "/user";
                    } else {
                        Modal.alert({
                            msg: result.Msg
                        })
                    }
                }, 'json');
                return false;
            });

            $(".date").on('dp.change dp.show', function (e) {
                // Validate the date when user change it
                $('#txform')
                    // Get the bootstrapValidator instance
                    .data('bootstrapValidator')
                    // Mark the field as not validated, so it'll be re-validated when the user change date
                    .updateStatus('revalidateField', 'NOT_VALIDATED', null)
                    // Validate the field
                    .validateField('Birthday');
            });


            $("#txsubmit").click(function () {
                if ($("#ParentId").val().length <= 0) {
                    Modal.alert({
                        msg: "请选填写会员基本信息"
                    });
                    $("a[href='#settings']").click();
                } else {
                    $('#txform').bootstrapValidator('validate');
                    if ($("#txform").data('bootstrapValidator').isValid()) {
                        //$("#txform").submit();
                    }
                }
            });



        });

        function upimg(cbfun, str) {//上传文件页面上传成功后将返回图片的完整路径名，然后我们就可以将其插入编辑其中 

            if (str == "undefined" || str == "") {
                return;
            }
            //str = "<img src='" + str + "'></img>";


            CKEDITOR.tools.callFunction(cbfun, str, '')


            //CKEDITOR.instances.Content.insertHtml(str);//调用CKEditor的JS接口将图片插入 
            //close();
        }

    </script>
}